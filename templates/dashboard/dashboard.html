{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Finance Tracker{% endblock %}

{% block extra_css %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <header class="dashboard-header">
        <h1>My Finance Dashboard</h1>
        {% if not user.has_active_premium %}
        <div class="usage-info">
            <small>Free tier: {{ transaction_count }}/10 transactions used</small>
        </div>
        {% endif %}
    </header>

    <section class="stats">
        <div class="stat-card">
            <div>Total Balance</div>
            <h2 id="total-balance">£{{ balance|floatformat:2 }}</h2>
        </div>
        <div class="stat-card income">
            <div>Total Income</div>
            <h2 id="total-income">£{{ total_income|floatformat:2 }}</h2>
        </div>
        <div class="stat-card expense">
            <div>Total Expenses</div>
            <h2 id="total-expenses">£{{ total_expenses|floatformat:2 }}</h2>
        </div>
        <div class="chart-section">
            <h3>Income vs Expenses</h3>
            <canvas id="chart" width="100" height="100"></canvas>
        </div>
    </section>

    <section class="transactions">
        <div class="transactions-header">
            <h3>Recent Transactions</h3>
            <div class="filter-group">
                <button id="addTransactionBtn" onclick="openAddModal()">Add Transaction</button>
                <select id="filterType" onchange="applyFilters()">
                    <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Types</option>
                    <option value="income" {% if filter_type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if filter_type == 'expense' %}selected{% endif %}>Expense</option>
                </select>
                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="all" {% if category_filter == 'all' %}selected{% endif %}>All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"i" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionBody">
                    {% if transactions %}
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.category.name }}</td>
                        <td>{{ transaction.description }}</td>
                        <td class="{{ transaction.transaction_type }}">{{ transaction.transaction_type|title }}</td>
                        <td class="{{ transaction.transaction_type }}">£{{ transaction.amount|floatformat:2 }}</td>
                        <td>{{ transaction.date|date:"Y-m-d" }}</td>
                        <td>
                            <a href="javascript:void(0)"
                                onclick="openEditModal({{ transaction.id }}, '{{ transaction.category_id }}', '{{ transaction.description|escapejs }}', '{{ transaction.transaction_type }}', {{ transaction.amount }}, '{{ transaction.date|date:'Y-m-d' }}')" class="action-link">Edit</a>
                            <form method="POST" action="{% url 'transactions:delete' transaction.id %}"
                                style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn"
                                    onclick="return confirm('Are you sure you want to delete this transaction?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr id="noRecords">
                        <td colspan="6" style="text-align:center;">No transactions found. Add your first transaction!
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- Add Transaction Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Transaction</h2>
            <span class="close" onclick="closeAddModal()">&times;</span>
        </div>
        <form method="POST" action="{% url 'transactions:add' %}">
            {% csrf_token %}

            <div class="form-group">
                <label for="add_category_id">Category</label>
                <select id="add_category_id" name="category" class="form-control" required>
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                {% if not categories %}
                <small><a href="{% url 'categories:list' %}">Create a category first</a></small>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="add_description">Description</label>
                <input type="text" id="add_description" name="description" class="form-control" required
                    maxlength="200">
            </div>

            <div class="form-group">
                <label for="add_transaction_type">Type</label>
                <select id="add_transaction_type" name="transaction_type" class="form-control" required>
                    <option value="">Select Type</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>

            <div class="form-group">
                <label for="add_amount">Amount (£)</label>
                <input type="number" id="add_amount" name="amount" step="0.01" min="0.01" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="add_date">Date</label>
                <input type="date" id="add_date" name="date" class="form-control" required>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Add Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Transaction</h2>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <form method="POST" id="editForm">
            {% csrf_token %}

            <div class="form-group">
                <label for="edit_category_id">Category</label>
                <select id="edit_category_id" name="category" class="form-control" required>
                    <option value="">Select Category</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="edit_description">Description</label>
                <input type="text" id="edit_description" name="description" class="form-control" required
                    maxlength="200">
            </div>

            <div class="form-group">
                <label for="edit_transaction_type">Type</label>
                <select id="edit_transaction_type" name="transaction_type" class="form-control" required>
                    <option value="">Select Type</option>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>
            </div>

            <div class="form-group">
                <label for="edit_amount">Amount (£)</label>
                <input type="number" id="edit_amount" name="amount" step="0.01" min="0.01" class="form-control"
                    required>
            </div>

            <div class="form-group">
                <label for="edit_date">Date</label>
                <input type="date" id="edit_date" name="date" class="form-control" required>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Update Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart.js initialization
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                data: [{{ total_income }}, {{ total_expenses }}],
        backgroundColor: ['#4caf50', '#f44336']
    }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
    });

    function applyFilters() {
        const filterType = document.getElementById('filterType').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        window.location.href = `{% url 'dashboard:home' %}?filter=${filterType}&category=${categoryFilter}`;
    }

    // Modal Functions
    function openAddModal() {
        const modal = document.getElementById('addModal');
        modal.style.display = 'flex';
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('add_date').value = today;
    }

    function closeAddModal() {
        const modal = document.getElementById('addModal');
        modal.style.display = 'none';
        modal.querySelector('form').reset();
    }

    function openEditModal(id, categoryId, description, type, amount, date) {
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');

        // Set form action to the edit URL
        form.action = `/transactions/edit/${id}/`;

        // Populate form fields
        document.getElementById('edit_category_id').value = categoryId;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_transaction_type').value = type;
        document.getElementById('edit_amount').value = amount;
        document.getElementById('edit_date').value = date;

        modal.style.display = 'flex';
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.style.display = 'none';
        modal.querySelector('form').reset();
    }

    // Close modal when clicking outside of it
    window.onclick = function (event) {
        const addModal = document.getElementById('addModal');
        const editModal = document.getElementById('editModal');

        if (event.target === addModal) {
            closeAddModal();
        }
        if (event.target === editModal) {
            closeEditModal();
        }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeAddModal();
            closeEditModal();
        }
    });
</script>
{% endblock %}